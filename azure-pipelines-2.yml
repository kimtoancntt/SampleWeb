# =============================================
# Azure DevOps Pipeline - Build & Deploy to AKS
# =============================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - Dockerfile
      - index.html
      - k8s/*

# =============================================
# VARIABLES
# =============================================
variables:
  - group: github-credentials      # GITHUB_PAT, GITHUB_USERNAME
  - group: acr-credentials         # ACR_NAME, ACR_LOGIN_SERVER, ACR_PASSWORD, ACR_USERNAME
  - group: aks-config              # AZURE_RG, AKS_CLUSTER, KUBE_NAMESPACE
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: imageRepository
    value: 'nginx-website'
  - name: tag
    value: '$(Build.BuildId)'
  - name: acrServiceConnection
    value: 'acr-connection'         # üîπ Service connection type: Docker Registry (ACR)
  - name: azureRMConnection
    value: 'azure-rm-connection'    # üîπ Service connection type: Azure Resource Manager
  - name: kubernetesConnection
    value: 'aks-connection'         # üîπ Service connection type: Kubernetes

pool:
  vmImage: 'ubuntu-latest'

# =============================================
# STAGE 1 - BUILD & PUSH IMAGE
# =============================================
stages:
- stage: BuildAndPush
  displayName: "Build & Push Docker Image"
  jobs:
  - job: BuildDocker
    displayName: "Build Docker Image"
    steps:
    - checkout: self
      clean: true

    - script: |
        echo "‚úÖ Starting build for $(imageRepository):$(tag)"
        echo "ACR Server: $(ACR_LOGIN_SERVER)"
        echo "Dockerfile path: $(dockerfilePath)"
      displayName: "Display Build Info"

    # üîπ Login to Azure Container Registry
    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: login
        containerRegistry: $(acrServiceConnection)

    # üîπ Build Docker image
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        tags: |
          $(tag)
          latest

    # üîπ Push Docker image to ACR
    - task: Docker@2
      displayName: 'Push to ACR'
      inputs:
        command: push
        repository: $(imageRepository)
        tags: |
          $(tag)
          latest

    - script: |
        echo "‚úÖ Image successfully pushed to ACR"
        echo "Full path: $(ACR_LOGIN_SERVER)/$(imageRepository):$(tag)"
      displayName: "Build Summary"

# =============================================
# STAGE 2 - DEPLOY TO AKS
# =============================================
- stage: Deploy
  displayName: "Deploy to AKS"
  dependsOn: BuildAndPush
  condition: succeeded()

  jobs:
  - job: DeployK8s
    displayName: "Deploy App to AKS"
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self

    # üîπ 1. Get AKS credentials dynamically
    - task: Kubernetes@1
      displayName: 'Get AKS Credentials'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionEndpoint: $(azureRMConnection)
        azureResourceGroup: $(AZURE_RG)
        kubernetesCluster: $(AKS_CLUSTER)
        command: 'get'
        arguments: 'nodes'

    
    # Ki·ªÉm tra gi√° tr·ªã bi·∫øn image
    - script: |
        echo "=========================================="
        echo "üîç Ki·ªÉm tra gi√° tr·ªã image:"
        echo "$(ACR_LOGIN_SERVER)/$(imageRepository):$(tag)"
        echo "=========================================="
      displayName: 'Check Image Value'

    # Hi·ªÉn th·ªã n·ªôi dung manifest (n·∫øu d√πng Replace Tokens ho·∫∑c Helm)
    - script: |
        echo "üìÑ N·ªôi dung deployment.yaml:"
        cat $(Build.SourcesDirectory)/k8s/deployment.yaml
      displayName: 'Show Manifest File'
    # üîπ 2. Deploy manifests
    - task: KubernetesManifest@1
      displayName: 'Deploy to AKS'
      inputs:
        action: 'deploy'
        connectionType: 'kubernetes'
        kubernetesServiceConnection: $(kubernetesConnection)
        namespace: $(KUBE_NAMESPACE)
        manifests: |
          $(Build.SourcesDirectory)/k8s/deployment.yaml
          $(Build.SourcesDirectory)/k8s/service.yaml
        containers: |
          $(ACR_LOGIN_SERVER)/$(imageRepository):$(tag)

    # üîπ 3. Verify deployment
    - script: |
        kubectl get pods -n $(KUBE_NAMESPACE)
        kubectl get svc -n $(KUBE_NAMESPACE)
      displayName: 'Verify Deployment'
